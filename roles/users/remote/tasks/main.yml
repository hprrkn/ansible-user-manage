---
- name: include vars
  include_vars: roles/users/base_local/vars/user_list.yml

- name: add a new group
  group: name='{{item.name}}' gid='{{item.id}}'
  with_items:
    - '{{users}}'

- name: add a new user
  user: name='{{item.name}}' state=present generate_ssh_key=no groups='{{item.group}}' group='{{item.name}}' uid='{{item.id}}'
  register: adduser_result
  with_items:
    - '{{users}}'

- name: delete user
  user: name='{{item.name}}' state=absent
  with_items:
    - '{{users}}'
  register: delete_user_result
  when:
    - item.state == "absent"

- name: delete user_home_dir
  file: path='{{item.home}}'
  with_items: '{{delete_user_result.results}}'
  when: item.changed == True

- name: mk .ssh
  file: path={{item.home}}/.ssh mode=700 group='{{item.name}}' owner='{{item.name}}' state=directory
  with_items: '{{adduser_result.results}}'
  when: item.changed == True

- name: cp authorized_key
  copy: src=roles/users/tmp/tmp_authorized_keys/'{{item.name}}'.pub dest='{{item.home}}'/.ssh/authorized_keys mode=600 group='{{item.name}}' owner='{{item.name}}'
  with_items: '{{adduser_result.results}}'
  when: item.changed == True
